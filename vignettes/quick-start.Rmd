---
title: "Quick Start"
author: "Paradigm4"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quick Start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r echo=FALSE}
# library(arrayop)
devtools::load_all(export_all = F)
auth = yaml::yaml.load_file("~/.scidb_auth")
conn = arrayop::connect(host = "localhost", username = auth[["user-name"]], token = auth[["user-password"]])
```


# Connect to SciDB

```{r}
# First, load user name and token from an authentication file, which is also compatible with iquery.
auth = yaml::yaml.load_file("~/.scidb_auth")
conn = arrayop::connect(host = "localhost", username = auth[["user-name"]], token = auth[["user-password"]])
print(conn) # print out `username@host [scidb version]`
```


# Run raw AFL in SciDB

To run AFL statements (in string aka. R character format), use one of the methods of a `ScidbConnection`:

  1. `ScidbConnection$query` if we expect results (normally as R data frames)
  1. `ScidbConnection$execute` if we do not expect results 
  
```{r}
conn$query("list('operators')")
conn$query("op_scidbversion()")
```
  
```{r}
conn$execute("create array temp_disposable_array <a:int32, b:string, c:bool> [z]")
conn$query("show(temp_disposable_array)")
conn$execute("remove(temp_disposable_array)")
# catch a query error
tryCatch(conn$query("show(temp_disposable_array)"), error = print)
```

## Chain AFL operators with pipes

We can pipe multiple SciDB operators in `arrayop::afl` function which returns an AFL string.

Depending on the number of operands:

  - `afl(a | b)` is converted to `b(a)`
  - `afl(a | b(c))` is converted to `b(a, c)`

```{r}
conn$query(arrayop::afl(
  "'operators'" | list | filter("library != 'scidb'") | limit(10)
))
```


# Interact with SciDB Arrays

We normally deal with a database with array already populated. 
In this case, let's first create an array.
```{r}
# Try to remove the temp array just in case it exists
try(conn$execute("remove(temparray_quick_start)"), silent = TRUE)
conn$execute("create array temparray_quick_start <a:int32, b:string, c:bool> [z]")
```

## Get an Array instance 

```{r}
tempArray = conn$array_op_from_name("public.temparray_quick_start") # here we use an explicit "public" namespace which is optional
print(tempArray) 
print(tempArray$to_afl())
print(tempArray$to_schema_str())
```

## Store a data frame into an existing Array
```{r}
df = data.frame(a=1:10, b=letters[1:10], c=c(T,F,F,T,NA), z=101:110)
build = tempArray$build_new(df = df)
overwriteOp = build$change_schema(tempArray)$overwrite(tempArray)
overwriteOp$execute()
tempArray$to_df()
```

## Handy methods to inspect Array

```{r}
tempArray$summarize()
tempArray$row_count()
tempArray$head(5)
tempArray$head(5, skip = 3)
```


## Filter Array data

```{r}
tempArray$where(z >= 105)$to_df()
tempArray$where(not_null(c))$to_df()

tempArray$where(z >= 105, not_null(c))$to_df() # AND
tempArray$where(z >= 105 || is_null(c))$to_df() # OR
```
## Modify Array data

There is no in-place modification similar to SQL `update` in either `arrayop` package or SciDB. 
So we need to create a mutated data array and then overwrite the original with it.

```{r}
mutated = tempArray$where(z > 105)$mutate(list(b = "'mutated'"))
# notice that `mutated` is just an Array instance in R and a piece of AFL for SciDB, 
# but not materialized or stored into any array
mutated$to_afl()
mutated$to_df()

# The original tempArray is not changed
tempArray$to_df()

# Now let's update the tempArray. 
mutated$update(tempArray)$execute()
tempArray$to_df()

# Now restore the array content
build$change_schema(tempArray)$overwrite(tempArray)$execute()
# And try 'overwrite' the tempArray
mutated$overwrite(tempArray)$execute()
tempArray$to_df()

```
## Remove Arrays and array versions

**Danger Zone Alert**
Remove operations cannot be undone!!! 

```{r}
# Let's create many versions
for(i in 1:10){
  build$change_schema(tempArray)$overwrite(tempArray)$execute()
}

# List array versions
tempArray$versions()

# Remove versions up to a version_id so that the version_id is the earliest version remaining 
tempArray$remove_versions(version_id = 5)
tempArray$versions()

# Or just remove all versions
tempArray$remove_versions()
tempArray$versions()
```
Ready to finally remove the temp array? 
```{r}
tempArray$remove_self()

# tempArray is no longer available!
tryCatch(tempArray$versions(), error = print)
```

